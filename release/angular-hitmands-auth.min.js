/**!
 * @Project: angular-hitmands-auth
 * @Authors: Giuseppe Mandato <gius.mand.developer@gmail.com>
 * @Link: https://github.com/hitmands/angular-hitmands-auth
 * @License: MIT
 * @Date: 2015-01-29
 * @Version: 0.0.1
***/

!function(a,b){"use strict";function c(a,b,c,d,e){function f(){e(function(){d.path("/")},0)}a.$on("$stateChangeStart",function(c,d,e,g,h){if(!b.authorize(d,b.getCurrentUser())){var i=b.isUserLoggedIn();c.preventDefault(),a.$broadcast("$stateChangeError",d,e,g,h,{statusCode:i?403:401,statusText:i?"Forbidden":"Unauthorized",isUserLoggedIn:i,publisher:"AuthService.authorize"}),g.name||f()}}),a.$on(i.update,function(){b.authorize(c.current,b.getCurrentUser())||f()})}function d(a){function c(){return j.getLoggedUser()instanceof AuthCurrentUser}function d(){return l}function e(a,c){return b.isNumber(c)||(c=0),c>=a}function f(a,c){c=b.isArray(c)?c:[c];for(var d=0,e=a.length;e>d;d++)for(var f=0,g=c.length;g>f;f++)if(b.equals(a[d],c[f]))return!0;return!1}var g=function(a){return{user:a,token:a.token,authLevel:a.authLevel}},j=this,k=null,l=null,m=!1;this.useRoutes=function(a){return b.isObject(a)&&(h=b.extend(h,a)),this},this.getLoggedUser=function(){return k},this.tokenizeHttp=function(e){return(!b.isString(e)||e.length<1)&&(e="x-auth-token"),a.interceptors.push(function(){return{request:function(a){return c()&&b.isObject(a)&&a.hasOwnProperty("headers")&&(a.headers[e]=d()),a}}}),this},this.useHttpHeaderAuth=function(){return m=!0,this},this.setLoggedUser=function(a,c,d){return(b.isArray(a)||!b.isObject(a)||!b.isString(c)||c.length<1)&&(a=null,c=null),k=a?new AuthCurrentUser(a,d):null,l=c,this},this.parseHttpAuthData=function(a){return b.isFunction(a)&&(g=a),this},this.$get=["$rootScope","$http","$state","$exceptionHandler","$timeout","$q",function(a,k,l,n,o,p){function q(b,c,d){j.setLoggedUser(b,c,d),a.$broadcast(i.update),o(function(){a.$$phase||a.$digest()},0)}function r(a){return(!b.isObject(a)||!b.isObject(a.user)||!b.isString(a.token)||a.token.length<1)&&(n("AuthServiceProvider.parseHttpAuthData","Invalid callback passed. The Callback must return an object like {user: Object, token: String, authLevel: Number|Array}"),a={user:null,token:null}),a}return{login:function(b){var c={cache:!1};if(m){c.headers={Authorization:"Basic "+btoa((b.username||"")+":"+(b.password||""))};try{delete b.username,delete b.password}catch(d){b.username="",b.password=""}}return k.post(h.login,b,c).then(function(b){var c=r(g(b.data,b.headers(),b.status));return q(c.user,c.token,c.authLevel),a.$broadcast(i.login.success,b),b},function(b){return q(null,null,null),a.$broadcast(i.login.error,b),p.reject(b)})},fetchLoggedUser:function(){return k.get(h.fetch,{cache:!1}).then(function(b){var c=r(g(b.data,b.headers(),b.status));return q(c.user,c.token,c.authLevel),a.$broadcast(i.fetch.success,b),b},function(b){return q(null,null,null),a.$broadcast(i.fetch.error,b),p.reject(b)})},logout:function(){return k.post(h.logout,null,{cache:!1}).then(function(b){return q(null,null,null),a.$broadcast(i.logout.success,b),b},function(b){return q(null,null,null),a.$broadcast(i.logout.error,b),p.reject(b)})},setCurrentUser:function(a,c,d){return b.isArray(a)||!b.isObject(a)||!b.isString(d)||d.length<1?!1:(q(a,d,c),!0)},unsetCurrentUser:function(){return q(null,null,null),!0},getCurrentUser:function(){return j.getLoggedUser()},isUserLoggedIn:function(){return c()},authorize:function(a,c){var d,g=AuthCurrentUser.getAuthProperty();if(c=c||j.getLoggedUser(),!b.isObject(a)||Object.getPrototypeOf(l)!==Object.getPrototypeOf(a))return n("AuthService.authorize","first param must be ui-router $state"),!1;try{d=c[g]}catch(h){d=0}var i=(b.isObject(a.data)&&a.data.hasOwnProperty(g)?a.data[g]:a[g])||0;return b.isNumber(i)?e(i,d):b.isArray(i)?f(i,d):(n("AuthService.authorize","Cannot process authorization"),!1)},getAuthenticationToken:function(){return d()}}}]}function e(a){return{restrict:"A",link:function(c,d,e){var f=c[e.authLogin],g=null;try{g=c[d.attr("name")]}catch(h){}d.bind("submit",function(c){b.isObject(f)?b.isObject(g)&&g.hasOwnProperty("$invalid")&&g.$invalid?c.preventDefault():a.login(f):c.preventDefault()}),c.$on("$destroy",function(){d.unbind("submit")})}}}function f(a){return function(b,c){c.bind("click",function(){a.logout()}),b.$on("$destroy",function(){c.unbind("click")})}}function g(a){var b={loggedIn:"user-is-logged-in",notLoggedIn:"user-not-logged-in"};return{restrict:"A",scope:!1,link:function(c,d,e){function f(){a.isUserLoggedIn()?(e.$removeClass(b.notLoggedIn),e.$addClass(b.loggedIn)):(e.$removeClass(b.loggedIn),e.$addClass(b.notLoggedIn))}f(),c.$on(i.update,function(){f()})}}}c.$inject=["$rootScope","AuthService","$state","$location","$timeout"],d.$inject=["$httpProvider"],e.$inject=["AuthService"],f.$inject=["AuthService"],g.$inject=["AuthService"];var h={login:"/users/login",logout:"/users/logout",fetch:"/users/me"},i={login:{success:"hitmands.auth:login.resolved",error:"hitmands.auth:login.rejected"},logout:{success:"hitmands.auth:logout.resolved",error:"hitmands.auth:logout.rejected"},fetch:{success:"hitmands.auth:fetch.resolved",error:"hitmands.auth:fetch.rejected"},update:"hitmands.auth:update"},AuthCurrentUser=function(){function AuthCurrentUser(b,c){for(var d in b)b.hasOwnProperty(d)&&d!==a&&Object.defineProperty(this,d,{value:b[d],configurable:!0,enumerable:!0,writable:!0});c=c||b[a]||0,Object.defineProperty(this,a,{value:c,configurable:!1,enumerable:!0,writable:!1})}var a="authLevel";return AuthCurrentUser.getAuthProperty=function(){return a},AuthCurrentUser}.call(this);b.module("hitmands.auth",["ui.router"]).provider("AuthService",d).directive("authLogin",e).directive("authLogout",f).directive("authClasses",g).run(c)}(window,angular);
