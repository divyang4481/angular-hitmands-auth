/**!
 * @Project: angular-hitmands-auth
 * @Authors: Giuseppe Mandato <gius.mand.developer@gmail.com>
 * @Link: https://github.com/hitmands/angular-hitmands-auth
 * @License: MIT
 * @Date: 2015-04-16
 * @Version: 1.1.0
 * 
 * @ngdoc: module
 * @namespace: hitmands
 * @name: auth
 * @module: hitmands.auth
 * @description: Full Implementation of an authentication management system.
***/

!function(a,b){"use strict";function c(a,b,c,d,e){function f(){e(function(){d.path(o.__redirectPath__)},0)}k&&(a.$on("$stateChangeStart",function(c,d,e,g,h){if(!b.authorize(d,b.getCurrentUser())){c.preventDefault();var i=b.isUserLoggedIn();a.$broadcast("$stateChangeError",d,e,g,h,{statusCode:i?403:401,statusText:i?"Forbidden":"Unauthorized",isUserLoggedIn:i,publisher:"AuthService.authorize"}),g.name||f()}}),a.$on(p.update,function(){b.authorize(c.current,b.getCurrentUser())||f()}))}function d(a,c){var d=!0;return(b.isArray(a)||!b.isObject(a))&&(d=!1),(!b.isString(c)||c.length<1)&&(d=!1),d}function e(a,c){return b.isNumber(c)||(c=0),c>=a}function f(a,c){if(c=b.isArray(c)?c:[c],a.length<1)return!0;for(var d=0,e=a.length;e>d;d++)for(var f=0,g=c.length;g>f;f++)if(b.equals(a[d],c[f]))return!0;return!1}function g(c){var g,h=this,i=!1;h.disableAutoRoutingProtection=function(){return k=!1,h},h.setRedirectPath=function(a){return h.useRoutes({__redirectPath__:a})},h.useRoutes=function(a){return o=b.extend(o,a),h},h.tokenizeHttp=function(a,d){return b.isFunction(a)&&(d=a,a=void 0),c.interceptors.push(function(){return{request:function(b){if(m instanceof AuthCurrentUser)try{b.headers[a||"x-auth-token"]=n}catch(c){}return b},responseError:d}}),h},h.useBasicAuthentication=function(){return i=!0,h},h.setLoggedUser=function(a,b,c){return d(a,b)||(a=null,b=null),m=a?new AuthCurrentUser(a,c):null,n=b,h},h.parseHttpAuthData=function(a){return b.isFunction(a)&&(g=a),h},h.$get=["$rootScope","$http","$state","$exceptionHandler","$timeout","$q","$injector",function(c,j,k,q,r,s,t){function u(a,b,d){h.setLoggedUser(a,b,d),c.$broadcast(p.update),r(function(){c.$$phase||c.$digest()},0)}return b.isFunction(g)||q("AuthServiceProvider.parseHttpAuthData","You need to set a Callback that handles the $http response. ","https://github.com/hitmands/angular-hitmands-auth#module-provider-parsehttpauthdata"),{login:function(b){var d={cache:!1};return i&&(d.headers={Authorization:"Basic "+a.btoa((b.username||"")+":"+(b.password||""))},delete b.username,delete b.password),j.post(o.login,b,d).then(function(a){var b=g(a.data,a.headers(),a.status);return u(b.user,b.token,b.authLevel),c.$broadcast(p.login.success,a),a},function(a){return u(),c.$broadcast(p.login.error,a),s.reject(a)})},fetch:function(){return j.get(o.fetch,{cache:!1}).then(function(a){var b=g(a.data,a.headers(),a.status);return u(b.user,b.token,b.authLevel),c.$broadcast(p.fetch.success,a),a},function(a){return u(),c.$broadcast(p.fetch.error,a),s.reject(a)})},logout:function(){return j.post(o.logout,null,{cache:!1}).then(function(a){return u(),c.$broadcast(p.logout.success,a),a},function(a){return u(),c.$broadcast(p.logout.error,a),s.reject(a)})},setCurrentUser:function(a,b,c){return d(a,c)?(u(a,c,b),!0):!1},unsetCurrentUser:function(){return u(),!0},getCurrentUser:function(){return m},isUserLoggedIn:function(){return m instanceof AuthCurrentUser},authorize:function(a,c){var d=0;if(c=c||m,!b.isObject(a))return q("AuthService.authorize","first param must be Object"),!1;var g=(a.data?a.data[l]:a[l])||0;try{d=c[l],g=t.invoke(g)}catch(h){}return b.isFunction(g)&&(g=t.invoke(g)),b.isNumber(g)?e(g,d):b.isArray(g)?f(g,d):(q("AuthService.authorize","Cannot process authorization"),!1)},check:function(a,b){return f(b,a)},getAuthenticationToken:function(){return n}}}]}function h(a){return{restrict:"A",link:function(c,d,e){var f=null,g=c[e.authLogin],h=c.$eval(e.authLoginOnResolve),i=c.$eval(e.authLoginOnReject);h=b.isFunction(h)?h:b.noop,i=b.isFunction(i)?i:b.noop;try{f=c[d.attr("name")]}catch(j){}d.bind("submit",function(c){return b.isObject(g)?b.isObject(f)&&f.$invalid?(c.preventDefault(),i(f.$error)):a.login(g).then(h,i):(c.preventDefault(),i({attrName:"auth-login",attrValue:g}))}),c.$on("$destroy",function(){d.unbind("submit")})}}}function i(a){return function(b,c){c.bind("click",function(){a.logout()}),b.$on("$destroy",function(){c.unbind("click")})}}function j(a){var b={loggedIn:"user-is-logged-in",notLoggedIn:"user-not-logged-in",last:""};return{restrict:"A",scope:!1,link:function(c,d,e){function f(){var c="";if(a.isUserLoggedIn()){try{c=" user-has-role-"+a.getCurrentUser()[l].join(" user-has-role-")}catch(d){}e.$updateClass(b.loggedIn+c,b.notLoggedIn),b.last=c}else e.$updateClass(b.notLoggedIn,b.loggedIn+b.last)}f(),c.$on(p.update,function(){f()})}}}c.$inject=["$rootScope","AuthService","$state","$location","$timeout"],g.$inject=["$httpProvider"],h.$inject=["AuthService"],i.$inject=["AuthService"],j.$inject=["AuthService"];var k=!0,l="authLevel",m=null,n=null,o={login:"/users/login",logout:"/users/logout",fetch:"/users/me",__redirectPath__:"/"},p={login:{success:"hitmands.auth:login.resolved",error:"hitmands.auth:login.rejected"},logout:{success:"hitmands.auth:logout.resolved",error:"hitmands.auth:logout.rejected"},fetch:{success:"hitmands.auth:fetch.resolved",error:"hitmands.auth:fetch.rejected"},update:"hitmands.auth:update"},AuthCurrentUser=function(){function AuthCurrentUser(a,b){for(var c in a)a.hasOwnProperty(c)&&c!==l&&(this[c]=a[c]);Object.defineProperty(this,l,{enumerable:!0,value:b||0})}return AuthCurrentUser}.call(this);b.module("hitmands.auth",["ui.router"]).provider("AuthService",g).directive("authLogin",h).directive("authLogout",i).directive("authClasses",j).run(c)}(window,angular);
