/**!
 * @Project: angular-hitmands-auth
 * @Authors: Giuseppe Mandato <gius.mand.developer@gmail.com>
 * @Link: https://github.com/hitmands/angular-hitmands-auth
 * @License: MIT
 * @Date: 2014-12-17
 * @Version: 0.0.1
***/

!function(a,b){"use strict";function c(a,b,c,d){a.$on("$stateChangeStart",function(c,e,f,g,h){if(!b.authorize(e,b.getCurrentUser())){var i=b.isUserLoggedIn();c.preventDefault(),a.$broadcast("$stateChangeError",e,f,g,h,{statusCode:i?403:401,statusText:i?"Forbidden":"Unauthorized",isUserLoggedIn:i,publisher:"AuthService.authorize"}),g.name||d.path("/")}}),a.$on(i.update,function(){b.authorize(c.current,b.getCurrentUser())||d.path("/")})}function d(a){function c(){return b.isObject(f.getLoggedUser())}function d(){return j}var e=function(a){return{user:a,token:a.token}},f=this,g=null,j=null;this.useRoutes=function(a){return b.isObject(a)&&(h=b.extend(h,a)),this},this.getLoggedUser=function(){return g},this.tokenizeHttp=function(e){return(!b.isString(e)||e.length<1)&&(e="x-auth-token"),a.interceptors.push(function(){return{request:function(a){return c()&&b.isObject(a)&&a.hasOwnProperty("headers")&&(a.headers[e]=d()),a}}}),this},this.setLoggedUser=function(a,c){return(b.isArray(a)||!b.isObject(a)||!b.isString(c)||c.length<1)&&(a=null,c=null),g=b.copy(a),j=c,this},this.defineModel=function(a){return b.isFunction(a)&&(e=a),this},this.$get=["$rootScope","$http","$exceptionHandler",function(a,g,j){function k(b,c){f.setLoggedUser(b,c),a.$broadcast(i.update)}function l(a){return(!b.isObject(a)||!b.isObject(a.user)||!b.isString(a.token)||a.token.length<1)&&(j("AuthService.defineModel","Invalid callback passed. The Callback must return an object like {user: Object, token: String}"),a={user:null,token:null}),a}return{login:function(b){return g.post(h.login,b,{cache:!1}).then(function(b){var c=l(e(b.data,b.headers(),b.status));return k(c.user,c.token),a.$broadcast(i.login.success,b),b},function(b){return k(null,null),a.$broadcast(i.login.error,b),b})},fetchLoggedUser:function(){return g.get(h.fetch,{cache:!1}).then(function(b){var c=l(e(b.data,b.headers(),b.status));return k(c.user,c.token),a.$broadcast(i.fetch.success,b),b},function(b){return k(null,null),a.$broadcast(i.fetch.error,b),b})},logout:function(){return g.post(h.logout,null,{cache:!1}).then(function(b){return k(null,null),a.$broadcast(i.logout.success,b),b},function(b){return k(null,null),a.$broadcast(i.logout.error,b),b})},setCurrentUser:function(a,c){b.isArray(a)||!b.isObject(a)||!b.isString(c)||c.length<1||k(a,c)},unsetCurrentUser:function(){k(null,null)},getCurrentUser:function(){return f.getLoggedUser()},isUserLoggedIn:function(){return c()},authorize:function(a,d){return b.isArray(a)||!b.isObject(a)?(j("AuthService.authorize","first params must be ui.router state"),!1):!b.isNumber(a.authLevel)||a.authLevel<1?!0:b.isObject(d)?(d.authLevel||0)>=a.authLevel:c()?(f.getLoggedUser().authLevel||0)>=a.authLevel:!1},getAuthenticationToken:function(){return d()}}}]}function e(a){var c=null;return{restrict:"A",link:function(d,e,f){var g=d[f.authLogin];try{c=d[e.attr("name")]}catch(h){}e.bind("submit",function(d){b.isObject(g)?b.isObject(c)&&c.hasOwnProperty("$invalid")&&c.$invalid?d.preventDefault():a.login(g):d.preventDefault()})}}}function f(a){return function(b,c){c.bind("click",function(){a.logout()})}}function g(a){var b={loggedIn:"user-is-logged-in",notLoggedIn:"user-not-logged-in"};return{restrict:"A",scope:!1,link:function(c,d,e){function f(){a.isUserLoggedIn()?(e.$addClass(b.loggedIn),e.$removeClass(b.notLoggedIn)):(e.$removeClass(b.loggedIn),e.$addClass(b.notLoggedIn))}f(),c.$on(i.update,function(){f()})}}}c.$inject=["$rootScope","AuthService","$state","$location"],d.$inject=["$httpProvider"],e.$inject=["AuthService"],f.$inject=["AuthService"],g.$inject=["AuthService"];var h={login:"/users/login",logout:"/users/logout",fetch:"/users/me"},i={login:{success:"hitmands.auth:login.resolved",error:"hitmands.auth:login.rejected"},logout:{success:"hitmands.auth:logout.resolved",error:"hitmands.auth:logout.rejected"},fetch:{success:"hitmands.auth:fetch.resolved",error:"hitmands.auth:fetch.rejected"},update:"hitmands.auth:update"};b.module("hitmands.auth",["ui.router"]).provider("AuthService",d).directive("authLogin",e).directive("authLogout",f).directive("authClasses",g).run(c)}(window,angular);
