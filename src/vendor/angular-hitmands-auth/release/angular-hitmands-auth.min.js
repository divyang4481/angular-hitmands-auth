/**!
 * @Project: angular-hitmands-auth
 * @Authors: Giuseppe Mandato <gius.mand.developer@gmail.com>
 * @Link: https://github.com/hitmands/angular-hitmands-auth
 * @License: MIT
 * @Date: 2014-11-02
 * @Version: 0.0.1
***/

!function(a,b){"use strict";function c(a){var c=this,d=null,e=null,f=function(a){return{user:a,token:a.token}},i=function(){return b.isObject(c.getLoggedUser())},j=function(){return e};this.useRoutes=function(a){return b.isObject(a)&&(g=b.extend(g,a)),this},this.getLoggedUser=function(){return d},this.tokenizeHttp=function(c){return(!b.isString(c)||c.length<1)&&(c="X-AUTH-TOKEN"),a.interceptors.push(function(){return{request:function(a){return i()&&b.isObject(a)&&a.hasOwnProperty("headers")&&(a.headers[c]=j()),a}}}),this},this.setLoggedUser=function(a,c){return(!b.isObject(a)||!b.isString(c)||c.length<1)&&(a=null,c=null),d=b.copy(a),e=c,this},this.setDataParser=function(a){return b.isFunction(a)&&(f=a),this},this.$get=["$rootScope","$q","$http","$exceptionHandler",function(a,d,e,k){var l=function(b,d){c.setLoggedUser(b,d),a.$broadcast(h.update,c.getLoggedUser(),i())},m=function(a){return(!b.isObject(a)||!b.isObject(a.user)||!b.isString(a.token)||a.token.length<1)&&(k("AuthService.processServerData","Invalid callback passed. The Callback must return an object like {user: Object, token: String}"),a={user:null,token:null}),a};return{login:function(b){return e.post(g.login,b,{cache:!1}).then(function(b){var c=m(f(b.data,b.headers(),b.status));return l(c.user,c.token),a.$broadcast(h.login.success,b),b},function(b){return l(null,null),a.$broadcast(h.login.error,b),b})},fetchLoggedUser:function(){return e.get(g.fetch,{cache:!1}).then(function(b){var c=m(f(b.data,b.headers(),b.status));return l(c.user,c.token),a.$broadcast(h.fetch.success,b),b},function(b){return l(null,null),a.$broadcast(h.fetch.error,b),b})},logout:function(){return e.post(g.logout,null,{cache:!1}).then(function(b){return l(null,null),a.$broadcast(h.logout.success,b),b},function(b){return l(null,null),a.$broadcast(h.logout.error,b),b})},setCurrentUser:function(a,b){l(a,b)},getCurrentUser:function(){return c.getLoggedUser()},isUserLoggedIn:function(){return i()},authorize:function(a){return!b.isNumber(a.authLevel)||a.authLevel<1?!0:i()?(c.getLoggedUser().authLevel||0)>=a.authLevel:!1},getAuthenticationToken:function(){return j()}}}]}function d(){var a=null,c=null;this.$get=["$state","AuthService",function(d,e){return{set:function(b,d){a=b,c=d},unset:function(){a=null,c=null},go:function(){b.isObject(a)&&e.authorize(a)&&d.go(a,c),this.unset()},otherwise:function(){return d.go(g.otherwise)}}}]}function e(a){var c=null;return{restrict:"A",link:function(d,e,f){var g=d[f.authLogin];try{c=d[e.attr("name")]}catch(h){}e.bind("submit",function(d){b.isObject(g)?b.isObject(c)&&c.hasOwnProperty("$invalid")&&c.$invalid?d.preventDefault():a.login(g):d.preventDefault()})}}}function f(a){return function(b,c){c.bind("click",function(){a.logout()})}}c.$inject=["$httpProvider"],e.$inject=["AuthService"],f.$inject=["AuthService"];var g={login:"/users/login",logout:"/users/logout",fetch:"/users/me",otherwise:"/login"},h={login:{success:"hitmands.auth:login.resolved",error:"hitmands.auth:login.rejected"},logout:{success:"hitmands.auth:logout.resolved",error:"hitmands.auth:logout.rejected"},fetch:{success:"hitmands.auth:fetch.resolved",error:"hitmands.auth:fetch.rejected"},update:"hitmands.auth:update"};b.module("hitmands.auth",["ui.router"]).run(["$rootScope","AuthService","$state","$location","AuthServiceRedirect",function(a,b,c,d,e){a.$on(h.login.success,function(){return e.go()}),a.$on("$stateChangeError",function(a,b,c,d,f,g){return 403===g.statusCode||401===g.statusCode?e.set(b,c):void 0}),a.$on("$stateChangeStart",function(c,f,g,h,i){if(!b.authorize(f)){var j=b.isUserLoggedIn();if(a.$broadcast("$stateChangeError",f,g,h,i,{statusCode:j?403:401,statusText:j?"Forbidden":"Unauthorized",isUserLoggedIn:j}),!h.name&&j)return d.path("/");if(c.preventDefault(),!h.name||!j)return e.otherwise()}}),a.$on(h.update,function(){var a=b.isUserLoggedIn();return!b.authorize(c.current)&&a?d.path("/"):b.authorize(c.current)||a?void 0:e.otherwise()})}]),b.module("hitmands.auth").provider("AuthService",c),b.module("hitmands.auth").provider("AuthServiceRedirect",d),b.module("hitmands.auth").directive("authLogin",e).directive("authLogout",f)}(window,angular);
